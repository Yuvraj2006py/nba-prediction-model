"""Check which games are missing GameMatchupFeatures."""

import sys
from pathlib import Path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

import os
os.environ['DATABASE_TYPE'] = 'sqlite'

from src.database.db_manager import DatabaseManager
from src.database.models import Game, GameMatchupFeatures
from datetime import date, timedelta

def check_matchup_features():
    """Check which finished games are missing GameMatchupFeatures."""
    db = DatabaseManager()
    today = date.today()
    yesterday = today - timedelta(days=1)
    
    print("=" * 70)
    print("CHECKING GAMEMATCHUPFEATURES STATUS")
    print("=" * 70)
    print(f"Checking dates: {yesterday} and {today}\n")
    
    with db.get_session() as session:
        # Get all finished games with scores
        all_finished = session.query(Game).filter(
            Game.game_status == 'finished',
            Game.home_score.isnot(None),
            Game.away_score.isnot(None)
        ).all()
        
        # Get games with GameMatchupFeatures
        games_with_features = set(
            session.query(GameMatchupFeatures.game_id).all()
        )
        games_with_features = {g[0] for g in games_with_features}
        
        # Find missing
        missing_games = []
        for game in all_finished:
            if game.game_id not in games_with_features:
                missing_games.append(game)
        
        print(f"Total finished games: {len(all_finished)}")
        print(f"Games with GameMatchupFeatures: {len(games_with_features)}")
        print(f"Games missing GameMatchupFeatures: {len(missing_games)}")
        
        if missing_games:
            print("\nMissing GameMatchupFeatures:")
            print("-" * 70)
            for game in sorted(missing_games, key=lambda g: g.game_date):
                print(f"  {game.game_id:30s} | Date: {game.game_date} | Season: {game.season}")
            
            # Check if any are from yesterday or today
            recent_missing = [g for g in missing_games if g.game_date in [yesterday, today]]
            if recent_missing:
                print(f"\nWARNING: {len(recent_missing)} missing games are from yesterday/today (should be generated by workflow)")
            else:
                print(f"\nOK: All missing games are older than yesterday (workflow only checks yesterday/today)")
        else:
            print("\nOK: All finished games have GameMatchupFeatures!")
        
        # Check yesterday/today specifically
        print("\n" + "=" * 70)
        print("YESTERDAY/TODAY CHECK (what workflow checks):")
        print("=" * 70)
        
        for check_date in [yesterday, today]:
            games_with_features_subq = session.query(GameMatchupFeatures.game_id).subquery()
            
            finished_games = session.query(Game).filter(
                Game.game_date == check_date,
                Game.game_status == 'finished',
                Game.home_score.isnot(None),
                Game.away_score.isnot(None),
                ~Game.game_id.in_(session.query(games_with_features_subq))
            ).all()
            
            print(f"\n{check_date}:")
            if finished_games:
                print(f"  WARNING: {len(finished_games)} games missing GameMatchupFeatures:")
                for game in finished_games:
                    print(f"     - {game.game_id}")
            else:
                print(f"  OK: All finished games have GameMatchupFeatures")
    
    print("\n" + "=" * 70)

if __name__ == "__main__":
    check_matchup_features()

